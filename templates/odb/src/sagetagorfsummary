[% PERL %]

use Mbl;  
use CGI qw(:all);
use CGI::Pretty;
use DBI;
  
use strict;

my $mbl = Mbl::new(path_info(), param('organism'));
my $dbh = $mbl->dbh();   

my $session_id = $stash->get('session_id');
my %session;

        tie %session, "Apache::Session::File", $session_id, {
                Directory => $mbl->session_tmp_dir,
        };

my $orfid;
if(param('orf') =~ /^orf\:/)
{
        ($orfid) = param('orf') =~ /^orf\:(\d+)/;
} else
{
        $orfid = param('orf');
}

if($mbl->check_orf_existance($orfid) && $mbl->has_sage())
{
	my $libh;

	my %totallib;

	# Find out totals for all libraries so we can get percentages also

	my $totallib = $mbl->get_sage_library_total_filtered();
	my $login_id = $session{'login_id'};

	my $access_list = $mbl->get_sage_access_libraries($login_id);

	$libh = $dbh->prepare("select library, name, short_name from sage_library_names where library IN ($access_list) ORDER BY library");

	$libh->execute();

	my $lib_resulth = $dbh->prepare("select result from sage_results where tagid = ? and library = ?");
	my $lib_short_string;
	my $expr_string;


	print center(h3("Serial Analysis of Gene Expression (SAGE) Tags"));
	print p("SAGE tags are mapped to theoretical transcripts, which are modeled as the complete Open Reading Frame (ORF) plus 15 bp of 3' UTR. This model is used for both sense and anti-sense transcripts. Primary SAGE tags are those generated by the most 3' Nla III restriction site on the theoretical transcript. All other placements are annotated as Alternate tags. Possible tag types are PS (primary sense tag), PA (primary anti-sense tag), AS (alternate sense tag), AA (alternate anti-sense tag), UK (unknown - not resolved to an ORF).");
	# Find the primary sense tag
	
	my $tagid = $mbl->get_orf_primary_tag($orfid);
	if($mbl->sage_tag_max_expr($tagid, $login_id) > 0)
	{
		# Do Nothing
	} else
	{
		# Unset the tagid
		$tagid = undef;
	}
	
	my $ps_tagref = $mbl->sage_orf_tagtypes_ref($orfid, "Primary Sense Tag", $login_id);
	my $as_tagref = $mbl->sage_orf_tagtypes_ref($orfid, "Alternate Sense Tag", $login_id);
	my $pa_tagref = $mbl->sage_orf_tagtypes_ref($orfid, "Primary Antisense Tag", $login_id);
	my $aa_tagref = $mbl->sage_orf_tagtypes_ref($orfid, "Alternate Antisense Tag", $login_id);
	
	print b("Number of SAGE tags assigned to ORF $orfid"),' [' . '<a href="?page=sagesearch&tag=orf:' . $orfid . '">view all</a>]', p;
	print 	center('<table width="80%">',
		TR(
			td(center(i("Primary Sense"))),
			td(center(i("Alternate Sense"))),
			td(center(i("Primary Anti-Sense"))),
			td(center(i("Alternate Anti-Sense")))
		),
		TR(
			td(center($mbl->create_overlib($ps_tagref->rows, $mbl->sage_ref_to_html($ps_tagref, "Primary Sense", $login_id), undef, 'STICKY') )),
			td(center($mbl->create_overlib($as_tagref->rows, $mbl->sage_ref_to_html($as_tagref, "Alternate Sense", $login_id), undef, 'STICKY'))),
			td(center($mbl->create_overlib($pa_tagref->rows, $mbl->sage_ref_to_html($pa_tagref, "Primary Anti-Sense", $login_id), undef, 'STICKY'))),
			td(center($mbl->create_overlib($aa_tagref->rows, $mbl->sage_ref_to_html($aa_tagref, "Alternate Anti-Sense", $login_id),undef, 'STICKY'))),
		),
		'</table>'), p;
			
	
	my $has_one = 0;
	
	if( $libh->rows > 0 && $tagid)
	{
	
		while(my $librow = $libh->fetchrow_hashref)
		{
			# For each library, get a result value and a percentage value
			$lib_resulth->execute($tagid, $librow->{library});
			my $result = 0;
			my $result_percent = 0;
		
			if($lib_resulth->rows > 0)
			{
				$result = $lib_resulth->fetchrow_hashref->{result};
				if($result > 0)
				{
					$has_one = 1;
				}
				$result_percent = ($result / $totallib->{$librow->{library}}) * 100;
			}
	
			my $perc = sprintf("%.5f", $result_percent);	
			$lib_short_string .= $librow->{short_name} . ",";
			$expr_string .= $perc . ",";
		
		}
	
		chop($lib_short_string);
		chop($expr_string);
	
		print b("Expression Levels of Primary Sense Tag " . $mbl->sagetag_link($tagid)), p;
		print center($mbl->sagetag_link($tagid, "<img src=\"/perl/graph_expr?libs=$lib_short_string&expr=$expr_string&width=400&height=200\" border=0>"));
	

	} elsif(!$tagid)
	{
	
	} else
	{
		print '<h3><font color="red">SAGE tag ID not recognized.</font></h3>';
		print '<h3>Contact <a href="mailto:gmod@lists.mbl.edu">gmod@lists.mbl.edu</a> for assistance.</h3>';
		print "You do not have access to any sage libraries or you have not loged in. You may log in <a href=\"?page=login\">here</a>";
	}
	print '<p><hr width="90%">';
} else
{
	# Print Nothing
}

untie(%session);

[% END %]
